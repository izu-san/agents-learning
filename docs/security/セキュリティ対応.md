# セキュリティ対応

セキュリティを意識した環境構築についてメモった。

## アーキテクチャ

```
家のつよつよPC
 ├─ Node.js
 ├─ AWS CLI
 ├─ Claude Code (Bedrock設定)
 └─ Playwright Agent
        ↓
    AWS Bedrock (Claude)
```

- [AWS Bedrockのセキュリティについて](AWS%20Bedrock調査.md)

## AWS側設定
****
省略。

- IAMユーザー作る
  - 個人検証なので `AmazonBedrockFullAccess` を付与しているが本番だと絞るべきだね。
- APIキーを発行する

### IAM設定について

Inference Profileを作成し、`bedrock:InvokeModel`と`bedrock:InvokeModelWithResponseStream`のみ許可する？

```
IAM Role
   |
   | (InvokeModelのみ)
   |
Inference Profile (Claude)
   |
Bedrock
```

## AWS CLIセットアップ

- https://aws.amazon.com/jp/cli/
- https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html

```
PS F:\Study\playwright\agents-learning> aws --version
aws-cli/2.33.12 Python/3.13.11 Windows/11 exe/AMD64
```

↓

```
PS F:\Study\playwright\agents-learning> aws configure
AWS Access Key ID [None]: 禁則事項です
AWS Secret Access Key [None]: 禁則事項です
Default region name [None]: us-east-1
Default output format [None]: json
```

↓

```
PS F:\Study\playwright\agents-learning> aws bedrock list-foundation-models | ConvertFrom-Json | Select-Object -ExpandProperty modelSummaries | Where-Object { $_.modelId -like "*claude*" }

modelArn                   : arn:aws:bedrock:us-east-1::foundation-model/anthropic.claude-sonnet-4-20250514-v1:0
modelId                    : anthropic.claude-sonnet-4-20250514-v1:0
modelName                  : Claude Sonnet 4
providerName               : Anthropic
inputModalities            : {TEXT, IMAGE}
outputModalities           : {TEXT}
responseStreamingSupported : True
customizationsSupported    : {}
inferenceTypesSupported    : {INFERENCE_PROFILE}
modelLifecycle             : @{status=ACTIVE}

以下略。 使用できるClaude系列がたくさん表示される。
```

## Claude Codeセットアップ

```
PS F:\Study\playwright\agents-learning> node -v       
v22.20.0

PS F:\Study\playwright\agents-learning> npm -v        
11.6.2
```

↓

```
PS F:\Study\playwright\agents-learning> npm install -g @anthropic-ai/claude-code

changed 2 packages in 2s

1 package is looking for funding
  run `npm fund` for details

PS F:\Study\playwright\agents-learning> claude --version
2.1.29 (Claude Code)
```

### `settings.json`作成

保存場所: `~/.claude/settings.json`  
Windowsだと `C:\Users\<ユーザー名>\.claude\settings.json`

モデルは好みで。

```json
{
    "env": {
        "AWS_REGION": "us-east-1",
        "ANTHROPIC_MODEL": "ここにモデルを設定",
        "ANTHROPIC_DEFAULT_HAIKU_MODEL": "ここにモデルを設定",
        "CLAUDE_CODE_USE_BEDROCK": "1"
    }
}
```

### 動作チェック

`/status`コマンド

```
  Version: 2.1.29
  Session name: /rename to add a name
  Session ID: 禁則事項です
  cwd: F:\Study\playwright\agents-learning
  API provider: AWS Bedrock
  AWS region: us-east-1

  Model: モデル情報が出るとこ
  IDE: Installed VS Code extension
  Memory:
  Setting sources: User settings
```

## Playwright Agentsセットアップ

```
npx playwright init-agents --loop=claude

 🎭 Using project "chromium" as a primary project
 🤖 .claude\agents\playwright-test-generator.md - agent definition
 🤖 .claude\agents\playwright-test-healer.md - agent definition
 🤖 .claude\agents\playwright-test-planner.md - agent definition
 🔧 .mcp.json - mcp configuration
 ✅ Done.
```

### 動作チェック

`API Usage Billing`だけどやった。  
1回だけだしそこまでお金かかってないと信じているよい。  
よくわかんないけど、めっちゃ時間かかった（10分くらい）

- 使用モデル: us.anthropic.claude-sonnet-4-5-20250929-v1:0

```
❯ @"playwright-test-planner(agent)"
以下サイトの実装詳細を確認して、実行すべきE2Eテスト項目を生成してください。
http://127.0.0.1:8080/ja/                                                                                        

● 指定されたサイトのE2Eテスト項目を生成します。playwright-test-plannerエージェントを起動して、実際のサイトを確認しながらテストプランを作成します。

● playwright-test-planner(Generate E2E test plan)
  ⎿  Done (29 tool uses · 84.0k tokens · 10m 20s)
                                                                                                                                                                  
● E2Eテストプランの生成が完了しました。
生成されたテストプラン
保存先: specs/enhanced-e2e-plan.md
http://127.0.0.1:8080/ja/ のサイトを実際にブラウザで確認し、以下の9つのカテゴリーで合計33個のテストケースを作成しました：

  テストカテゴリー

  1. ユーザビリティとアクセシビリティ (6テスト)
    - キーボードナビゲーション、ARIAラベル、レスポンシブデザインなど
  2. パフォーマンスと読み込み (3テスト)
    - ページ読み込み時間、画像の遅延読み込みなど
  3. セッション管理とステート管理 (4テスト)
    - セッションタイムアウト、複数タブでの同期など
  4. エラーハンドリングとリカバリー (4テスト)
    - ネットワークエラー、サーバーエラー時の挙動など
  5. ブラウザ間互換性 (3テスト)
    - Firefox、Safari、Edge での動作確認
  6. 国際化とローカライゼーション (3テスト)
    - 日付/通貨フォーマット、多言語対応など
  7. データ永続性とクッキー管理 (3テスト)
    - クッキー同意、ログイン状態保持など
  8. 統合テストとエンドツーエンドフロー (3テスト)
    - 完全な予約フロー、会員登録フローなど
  9. セキュリティとプライバシー (4テスト)
    - HTTPS接続、CSRFトークン、個人情報保護など

  各テストケースには、具体的な実行ステップと期待される結果が記載されています。詳細は生成されたマークダウンファイルをご確認ください。
```

- AI成果物: [/specs/enhanced-e2e-plan.md](../../specs/enhanced-e2e-plan.md)
